---
import type { Author } from "../types/types";

interface Props {
  authors: Author[];
  notes?: {
    symbol: string;
    text: string;
  }[];
  ordered_institutions?: string[]; // 新增参数：接收手动指定的顺序
}

const { authors, notes = [], ordered_institutions } = Astro.props;

// 1. 确定最终的机构列表
// 如果传入了 ordered_institutions，就直接用它；否则自动从作者里提取
const finalInstitutions = ordered_institutions || Array.from(
  new Set(
    authors
      .flatMap((author) => 
        Array.isArray(author.institution) 
          ? author.institution 
          : [author.institution]
      )
      .filter((inst): inst is string => Boolean(inst))
  )
);

// 2. 辅助函数：获取作者的上标内容
const getAuthorSuperscript = (author: Author) => {
  const parts: (string | number)[] = [];
  
  // 处理机构编号
  if (author.institution) {
    const authorInsts = Array.isArray(author.institution) 
      ? author.institution 
      : [author.institution];
      
    authorInsts.forEach((inst) => {
      // 在 finalInstitutions 里找位置 (索引+1)
      const index = finalInstitutions.indexOf(inst) + 1;
      if (index > 0) parts.push(index);
    });
  }
  
  // 处理备注符号 (*, †)
  if (author.notes) {
    parts.push(...author.notes);
  }
  
  return parts.join(",");
};
---

<div class="mt-6 mb-8 text-center">
  {/* --- 作者名字列表 --- */}
  <div class="flex flex-wrap justify-center gap-x-6 gap-y-2 text-lg sm:text-xl font-medium leading-relaxed">
    {
      authors.map((author, index) => {
        const isLast = index === authors.length - 1;
        const superscript = getAuthorSuperscript(author);
        
        return (
          <span class="relative inline-flex items-baseline">
            {author.url ? (
              <a 
                href={author.url} 
                target="_blank" 
                class="text-blue-600 hover:underline hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 transition-colors"
              >
                {author.name}
              </a>
            ) : (
              <span class="text-gray-900 dark:text-white">{author.name}</span>
            )}
            
            {superscript && (
              <sup class="text-sm text-gray-500 dark:text-gray-400 ml-0.5 -top-1 font-normal select-none">
                {superscript}
              </sup>
            )}
            
            {!isLast && <span class="text-gray-900 dark:text-white ml-0 mr-1">,</span>}
          </span>
        );
      })
    }
  </div>

  {/* --- 单位列表 (按照 finalInstitutions 顺序显示) --- */}
  <div class="mt-3 flex flex-wrap justify-center gap-x-6 gap-y-1 text-sm text-gray-600 dark:text-gray-300">
    {
      finalInstitutions.map((inst, index) => (
        <div class="flex items-center">
          <sup class="mr-1">{index + 1}</sup>
          <span>{inst}</span>
        </div>
      ))
    }
  </div>

  {/* --- 备注列表 --- */}
  {notes.length > 0 && (
    <div class="mt-3 flex flex-wrap justify-center gap-x-6 gap-y-1 text-sm text-gray-500 dark:text-gray-400">
      {notes.map((note) => (
        <div class="flex items-center">
          <sup class="mr-1">{note.symbol}</sup>
          <span class="italic">{note.text}</span>
        </div>
      ))}
    </div>
  )}
</div>